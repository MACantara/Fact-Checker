{% extends "base.html" %}

{% block title %}
{% if results %}Search Results for "{{ results.query }}"{% else %}Search{% endif %} - Philippine News Search
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Search Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Search Form -->
            <form action="{{ url_for('main.search') }}" method="GET" class="mb-4">
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="flex-1 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="bi bi-search text-gray-400"></i>
                        </div>
                        <input type="text" 
                               name="q" 
                               value="{{ query_data.query if query_data else '' }}" 
                               placeholder="Search news articles..." 
                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               required>
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        <select name="category" class="px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Categories</option>
                            {% if metadata and metadata.categories %}
                                {% for category in metadata.categories %}
                                    <option value="{{ category }}" {% if query_data and query_data.category == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                        
                        <select name="source" class="px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Sources</option>
                            {% if metadata and metadata.sources %}
                                {% for source in metadata.sources %}
                                    <option value="{{ source }}" {% if query_data and query_data.source == source %}selected{% endif %}>{{ source }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                        
                        <select name="sort_by" class="px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="relevance" {% if query_data and query_data.sort_by == 'relevance' %}selected{% endif %}>Most Relevant</option>
                            <option value="date" {% if query_data and query_data.sort_by == 'date' %}selected{% endif %}>Most Recent</option>
                        </select>
                        
                        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 transition-colors">
                            <i class="bi bi-search mr-1"></i>Search
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- Results Info -->
            {% if results %}
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center text-sm text-gray-600">
                <div>
                    <strong>{{ results.total }}</strong> results found for 
                    <strong>"{{ results.query }}"</strong>
                    {% if query_data and query_data.category %}
                        in <strong>{{ query_data.category }}</strong>
                    {% endif %}
                    {% if query_data and query_data.source %}
                        from <strong>{{ query_data.source }}</strong>
                    {% endif %}
                </div>
                <div class="mt-2 sm:mt-0">
                    Page {{ results.page }} of {{ results.pages }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% if error %}
        <!-- Error Message -->
        <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
            <div class="flex items-center">
                <i class="bi bi-exclamation-triangle text-red-500 text-xl mr-3"></i>
                <div>
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Search Error</h3>
                    <p class="text-red-700">{{ error }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if results and results.articles %}
        <!-- Search Results -->
        <div class="space-y-6">
            {% for article in results.articles %}
            <article class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 text-sm text-gray-500 mb-2">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                                {{ article.category }}
                            </span>
                            <span class="text-gray-400">•</span>
                            <span class="font-medium text-gray-700">{{ article.source }}</span>
                            <span class="text-gray-400">•</span>
                            <time class="text-gray-500">
                                {{ article.published.strftime('%B %d, %Y at %I:%M %p') if article.published else 'Unknown date' }}
                            </time>
                        </div>
                        
                        <h2 class="text-xl font-semibold text-gray-900 mb-3 leading-tight">
                            <a href="{{ article.link }}" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               class="hover:text-blue-600 transition-colors">
                                {{ article.title }}
                                <i class="bi bi-box-arrow-up-right text-sm ml-1 text-gray-400"></i>
                            </a>
                        </h2>
                        
                        {% if article.summary %}
                        <p class="text-gray-700 leading-relaxed mb-3">
                            {{ article.summary[:300] }}{% if article.summary|length > 300 %}...{% endif %}
                        </p>
                        {% endif %}
                        
                        {% if article.author %}
                        <div class="text-sm text-gray-500 mb-2">
                            <i class="bi bi-person mr-1"></i>By {{ article.author }}
                        </div>
                        {% endif %}
                        
                        {% if article.tags %}
                        <div class="flex flex-wrap gap-1 mt-3">
                            {% for tag in article.tags[:5] %}
                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">
                                {{ tag }}
                            </span>
                            {% endfor %}
                            {% if article.tags|length > 5 %}
                            <span class="text-gray-500 text-xs">+{{ article.tags|length - 5 }} more</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mt-4 lg:mt-0 lg:ml-6 flex-shrink-0">
                        <a href="{{ article.link }}" 
                           target="_blank" 
                           rel="noopener noreferrer"
                           class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 transition-colors">
                            <i class="bi bi-arrow-right mr-2"></i>Read Article
                        </a>
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if results.pages > 1 %}
        <div class="mt-12">
            <nav class="flex justify-center" aria-label="Pagination">
                <div class="flex items-center space-x-2">
                    <!-- Previous Page -->
                    {% if results.has_prev %}
                    <a href="{{ url_for('main.search', q=results.query, page=results.page-1, category=query_data.category if query_data else '', source=query_data.source if query_data else '', sort_by=query_data.sort_by if query_data else 'relevance') }}" 
                       class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700">
                        <i class="bi bi-chevron-left mr-1"></i>Previous
                    </a>
                    {% endif %}
                    
                    <!-- Page Numbers -->
                    {% set start_page = [1, results.page - 2]|max %}
                    {% set end_page = [results.pages, results.page + 2]|min %}
                    
                    {% if start_page > 1 %}
                    <a href="{{ url_for('main.search', q=results.query, page=1, category=query_data.category if query_data else '', source=query_data.source if query_data else '', sort_by=query_data.sort_by if query_data else 'relevance') }}" 
                       class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700">1</a>
                    {% if start_page > 2 %}
                    <span class="px-3 py-2 text-sm font-medium text-gray-400">...</span>
                    {% endif %}
                    {% endif %}
                    
                    {% for page_num in range(start_page, end_page + 1) %}
                    {% if page_num == results.page %}
                    <span class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md">{{ page_num }}</span>
                    {% else %}
                    <a href="{{ url_for('main.search', q=results.query, page=page_num, category=query_data.category if query_data else '', source=query_data.source if query_data else '', sort_by=query_data.sort_by if query_data else 'relevance') }}" 
                       class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700">{{ page_num }}</a>
                    {% endif %}
                    {% endfor %}
                    
                    {% if end_page < results.pages %}
                    {% if end_page < results.pages - 1 %}
                    <span class="px-3 py-2 text-sm font-medium text-gray-400">...</span>
                    {% endif %}
                    <a href="{{ url_for('main.search', q=results.query, page=results.pages, category=query_data.category if query_data else '', source=query_data.source if query_data else '', sort_by=query_data.sort_by if query_data else 'relevance') }}" 
                       class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700">{{ results.pages }}</a>
                    {% endif %}
                    
                    <!-- Next Page -->
                    {% if results.has_next %}
                    <a href="{{ url_for('main.search', q=results.query, page=results.page+1, category=query_data.category if query_data else '', source=query_data.source if query_data else '', sort_by=query_data.sort_by if query_data else 'relevance') }}" 
                       class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700">
                        Next<i class="bi bi-chevron-right ml-1"></i>
                    </a>
                    {% endif %}
                </div>
            </nav>
        </div>
        {% endif %}

        {% elif results %}
        <!-- No Results -->
        <div class="text-center py-12">
            <div class="max-w-md mx-auto">
                <i class="bi bi-search text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No results found</h3>
                <p class="text-gray-500 mb-6">
                    Try different keywords, check your spelling, or broaden your search.
                </p>
                <a href="{{ url_for('main.index') }}" 
                   class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="bi bi-house mr-2"></i>Back to Home
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-focus search input if no results
        {% if not results or not results.articles %}
        const searchInput = document.querySelector('input[name="q"]');
        if (searchInput) {
            searchInput.focus();
        }
        {% endif %}
        
        // Track external link clicks
        document.querySelectorAll('a[target="_blank"]').forEach(link => {
            link.addEventListener('click', function() {
                console.log('External link clicked:', this.href);
            });
        });
    });

    // Form submission loading
    document.querySelector('form').addEventListener('submit', function() {
        showLoading();
    });
</script>
{% endblock %}
